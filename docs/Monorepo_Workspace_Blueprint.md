# Monorepo Workspace Blueprint

> **Owner:** System Architect (Winston)
> **Related Tasks:** establish_monorepo_workspace, choose_package_manager_poetry, implement_dependency_policies
> **Status:** Draft – awaiting stakeholder review

---

## 🎯 Objectives

1. **Single-source dependency management** for all Python projects using Poetry.
2. **Unified JavaScript/TypeScript workspace** using pnpm to speed installs & avoid duplication.
3. **Reproducible builds** via lock files (`poetry.lock`, `pnpm-lock.yaml`).
4. **CI/CD simplification** – one setup per language ecosystem.
5. **Developer Ergonomics** – seamless local dev across packages.

---

## 🗂️ Proposed Directory Structure

```
MemoryBank/
├── pyproject.toml           # Root aggregator for Poetry workspace
├── poetry.lock              # Global lock generated by `poetry lock -n`
├── pnpm-workspace.yaml      # Lists JS packages
├── packages/                # (optional) shared libs
│   └── python-utils/
│       ├── pyproject.toml
│       └── ...
├── custom-gpt-adapter/      # existing
│   └── pyproject.toml       # becomes Poetry project
├── mem0/
│   └── pyproject.toml       # already Hatch –> migrate to Poetry
├── mem0/embedchain/
│   └── pyproject.toml       # Poetry project (already)
└── <other JS apps>
    └── package.json
```

---

## 🐍 Python (Poetry) Workspace

1. **Enable workspace mode** in root `pyproject.toml`:

   ```toml
   [tool.poetry]
   name = "memorybank-monorepo"
   version = "0.0.0"
   description = "Workspace aggregator – no code here."
   packages = []

   [tool.poetry.group.workspace]
   optional = true
   ```

2. **Path dependencies** – reference sub-projects:

   ```toml
   [tool.poetry.dependencies]
   custom-gpt-adapter = {path = "custom-gpt-adapter", develop = true}
   mem0 = {path = "mem0", develop = true}
   embedchain = {path = "mem0/embedchain", develop = true}
   python-utils = {path = "packages/python-utils", develop = true, optional = true}
   ```

3. **Scripts** – convenience wrappers in `[tool.poetry.scripts]` (lint, test-all).
4. **Virtualenv strategy** – enable `poetry config virtualenvs.in-project true` (keeps envs per project).
5. **Migration Steps**:
   1. Convert Hatch projects (`root`, `mem0`) to Poetry via `poetry init` + dependency import.
   2. Generate fresh `poetry.lock` at root: `poetry lock -n`.
   3. Update CI to use `poetry install --all-extras` at workspace root.

---

## 🟦 JavaScript/TypeScript (pnpm) Workspace

1. Root `pnpm-workspace.yaml`:

   ```yaml
   packages:
     - "openmemory/ui"      # example
     - "mem0-ts/packages/*"
     - "vercel-ai-sdk/*"
   ```

2. **Common scripts** in `package.json` (root) to run lint, test, build across workspaces.
3. Use `pnpm install` – stores shared dependencies in `.pnpm` directory.
4. **CI** – use `pnpm install --frozen-lockfile` to respect lock file.

---

## 🔄 CI/CD Pipeline Updates

| Step | Tool | Command |
|------|------|---------|
| Install Python deps | Poetry | `poetry install --all-extras --no-root` |
| Install JS deps | pnpm | `pnpm install --frozen-lockfile` |
| Lint | Ruff / ESLint | `poetry run ruff` / `pnpm lint` |
| Tests | Pytest / Jest | `poetry run pytest` / `pnpm test` |
| Build images | Docker | Multi-stage with cached layers |

Add a **Reusable GitHub Actions workflow** (`.github/workflows/ci.yaml`) with matrix over `python-version` & `node-version`.

---

## 📜 Governance & Conventions

1. **Naming** – each sub-project must specify `[tool.poetry] name` and semantic version.
2. **Lock files** – always commit `poetry.lock` and `pnpm-lock.yaml`.
3. **Version policy** – patch releases ≤ 7 days; minor ≤ 1 month; major handled via RFC.
4. **Security scanning** – Trivy & Safety run in CI for each lock file.
5. **Publishing** – internal packages published to private registry if needed.

---

## 🚧 Open Questions / Next Steps

1. Confirm whether root code will remain or be split into sub-package (e.g., `core-api`).
2. Decide on workspace location for shared utilities (`packages/python-utils`).
3. Finalize CI runner caching strategy (Poetry cache + pnpm store).
4. Schedule migration sprint – estimate 2-3 dev-days.

---

*End of Blueprint – please review and comment.* 