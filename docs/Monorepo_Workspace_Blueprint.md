# Monorepo Workspace Blueprint

> **Owner:** System Architect (Winston)
> **Related Tasks:** establish_monorepo_workspace, choose_package_manager_poetry, implement_dependency_policies
> **Status:** Draft â€“ awaiting stakeholder review

---

## ğŸ¯ Objectives

1. **Single-source dependency management** for all Python projects using Poetry.
2. **Unified JavaScript/TypeScript workspace** using pnpm to speed installs & avoid duplication.
3. **Reproducible builds** via lock files (`poetry.lock`, `pnpm-lock.yaml`).
4. **CI/CD simplification** â€“ one setup per language ecosystem.
5. **Developer Ergonomics** â€“ seamless local dev across packages.

---

## ğŸ—‚ï¸ Proposed Directory Structure

```
MemoryBank/
â”œâ”€â”€ pyproject.toml           # Root aggregator for Poetry workspace
â”œâ”€â”€ poetry.lock              # Global lock generated by `poetry lock -n`
â”œâ”€â”€ pnpm-workspace.yaml      # Lists JS packages
â”œâ”€â”€ packages/                # (optional) shared libs
â”‚   â””â”€â”€ python-utils/
â”‚       â”œâ”€â”€ pyproject.toml
â”‚       â””â”€â”€ ...
â”œâ”€â”€ custom-gpt-adapter/      # existing
â”‚   â””â”€â”€ pyproject.toml       # becomes Poetry project
â”œâ”€â”€ mem0/
â”‚   â””â”€â”€ pyproject.toml       # already Hatch â€“> migrate to Poetry
â”œâ”€â”€ mem0/embedchain/
â”‚   â””â”€â”€ pyproject.toml       # Poetry project (already)
â””â”€â”€ <other JS apps>
    â””â”€â”€ package.json
```

---

## ğŸ Python (Poetry) Workspace

1. **Enable workspace mode** in root `pyproject.toml`:

   ```toml
   [tool.poetry]
   name = "memorybank-monorepo"
   version = "0.0.0"
   description = "Workspace aggregator â€“ no code here."
   packages = []

   [tool.poetry.group.workspace]
   optional = true
   ```

2. **Path dependencies** â€“ reference sub-projects:

   ```toml
   [tool.poetry.dependencies]
   custom-gpt-adapter = {path = "custom-gpt-adapter", develop = true}
   mem0 = {path = "mem0", develop = true}
   embedchain = {path = "mem0/embedchain", develop = true}
   python-utils = {path = "packages/python-utils", develop = true, optional = true}
   ```

3. **Scripts** â€“ convenience wrappers in `[tool.poetry.scripts]` (lint, test-all).
4. **Virtualenv strategy** â€“ enable `poetry config virtualenvs.in-project true` (keeps envs per project).
5. **Migration Steps**:
   1. Convert Hatch projects (`root`, `mem0`) to Poetry via `poetry init` + dependency import.
   2. Generate fresh `poetry.lock` at root: `poetry lock -n`.
   3. Update CI to use `poetry install --all-extras` at workspace root.

---

## ğŸŸ¦ JavaScript/TypeScript (pnpm) Workspace

1. Root `pnpm-workspace.yaml`:

   ```yaml
   packages:
     - "openmemory/ui"      # example
     - "mem0-ts/packages/*"
     - "vercel-ai-sdk/*"
   ```

2. **Common scripts** in `package.json` (root) to run lint, test, build across workspaces.
3. Use `pnpm install` â€“ stores shared dependencies in `.pnpm` directory.
4. **CI** â€“ use `pnpm install --frozen-lockfile` to respect lock file.

---

## ğŸ”„ CI/CD Pipeline Updates

| Step | Tool | Command |
|------|------|---------|
| Install Python deps | Poetry | `poetry install --all-extras --no-root` |
| Install JS deps | pnpm | `pnpm install --frozen-lockfile` |
| Lint | Ruff / ESLint | `poetry run ruff` / `pnpm lint` |
| Tests | Pytest / Jest | `poetry run pytest` / `pnpm test` |
| Build images | Docker | Multi-stage with cached layers |

Add a **Reusable GitHub Actions workflow** (`.github/workflows/ci.yaml`) with matrix over `python-version` & `node-version`.

---

## ğŸ“œ Governance & Conventions

1. **Naming** â€“ each sub-project must specify `[tool.poetry] name` and semantic version.
2. **Lock files** â€“ always commit `poetry.lock` and `pnpm-lock.yaml`.
3. **Version policy** â€“ patch releases â‰¤ 7 days; minor â‰¤ 1 month; major handled via RFC.
4. **Security scanning** â€“ Trivy & Safety run in CI for each lock file.
5. **Publishing** â€“ internal packages published to private registry if needed.

---

## ğŸš§ Open Questions / Next Steps

1. Confirm whether root code will remain or be split into sub-package (e.g., `core-api`).
2. Decide on workspace location for shared utilities (`packages/python-utils`).
3. Finalize CI runner caching strategy (Poetry cache + pnpm store).
4. Schedule migration sprint â€“ estimate 2-3 dev-days.

---

*End of Blueprint â€“ please review and comment.* 